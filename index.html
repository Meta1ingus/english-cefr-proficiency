<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>English Language CEFR Proficiency Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light p-4">
  <div class="container">
    <h1 class="mb-4">ðŸŽ“ English Language CEFR Proficiency Test</h1>

    <div class="row mb-3">
      <div class="col-md-4">
        <label for="category" class="form-label">Category:</label>
        <select class="form-select" id="category">
          <option value="">-- Any --</option>
          <option value="Listening">Listening</option>
          <option value="Reading">Reading</option>
          <option value="Grammar">Grammar</option>
        </select>
      </div>

      <div class="col-md-4">
        <label for="difficulty" class="form-label">Difficulty:</label>
        <select class="form-select" id="difficulty">
          <option value="">-- Any --</option>
          <option value="A1">A1</option>
          <option value="B1">B1</option>
          <option value="C1">C1</option>
        </select>
      </div>

      <div class="col-md-4 d-flex align-items-end">
        <button id="loadBtn" class="btn btn-primary w-100">Load Question</button>
      </div>
    </div>

    <div id="questionBox" class="card shadow p-3 d-none">
      <h5 id="questionText"></h5>
      <audio id="audio" class="my-2" controls></audio>
      <img id="image" class="img-fluid my-2" alt="" style="max-height: 250px; display: none;" />

      <ul id="choices" class="list-group mt-3"></ul>
    </div>
  </div>

  <script>
    let questions = [];

    async function fetchQuestions() {
      const res = await fetch("http://127.0.0.1:8000/questions");
      questions = await res.json();
    }

    function pickRandom(filtered) {
      return filtered[Math.floor(Math.random() * filtered.length)];
    }

    function renderQuestion(q) {
      document.getElementById("questionBox").classList.remove("d-none");
      document.getElementById("questionText").textContent = q.questionText;

      const audioEl = document.getElementById("audio");
      if (q.audio) {
        audioEl.src = q.audio;
        audioEl.style.display = "block";
      } else {
        audioEl.style.display = "none";
      }

      const imgEl = document.getElementById("image");
      if (q.image) {
        imgEl.src = q.image;
        imgEl.style.display = "block";
      } else {
        imgEl.style.display = "none";
      }

      const choicesEl = document.getElementById("choices");
      choicesEl.innerHTML = "";
      q.choices.forEach(choice => {
        const li = document.createElement("li");
        li.textContent = choice;
        li.className = "list-group-item";
        choicesEl.appendChild(li);
      });
    }

    document.getElementById("loadBtn").addEventListener("click", () => {
      const cat = document.getElementById("category").value;
      const diff = document.getElementById("difficulty").value;

      const filtered = questions.filter(q => {
        const catMatch = !cat || q.category === cat;
        const diffMatch = !diff || q.difficulty === diff;
        return catMatch && diffMatch;
      });

      if (filtered.length === 0) {
        alert("No matching questions found.");
        return;
      }

      const selected = pickRandom(filtered);
      renderQuestion(selected);
    });

    fetchQuestions();
  </script>
</body>
</html>
